%META:TOPICPARENT{name="Plugins"}%
---+ Multi Topic Save Plugin

%SHORTDESCRIPTION%

%ATTACHURL%/example.png <br />
_Example screenshot_

This plugin allows the user to submit updates to the dataform in multiple topics in one single edit/submit cycle.

The users can create a topic which displays the fields from many topics as editable fields. The users can edit the field values and when they click a submit button all the topics with fields that were changed will be updated.

The plugin will ignore topics that the user does not have write access to.


---++ Examples

In the following example the plugin is used to

   * Make a formatted search which finds a number of topics
   * Display selected fields in editable form. The field types are text, textarea, radio, checkbox, and select (all the formats supported by the plugin)
   * Note that with field types where we want to know the content a field from each found topic, we need to delay the expansion of MULTITOPICSAVEINPUT till after the SEARCH is complete and has produced its result. This is why the macro is escaped by $percnt and $quot for the types radio, checkbox, and select.

<verbatim>
<form action='%SCRIPTURL{"rest"}%/MultiTopicSavePlugin/multitopicsave' method="post">

%SEARCH{"MultiTopicSaveTestTarget" scope="topic" nonoise="on"
    format="| $topic | %MULTITOPICSAVEINPUT{"Option" type="text" size="20" web="$web" topic="$topic" value="$formfield(Option)"}% | %MULTITOPICSAVEINPUT{"Description" type="textarea" web="$web" topic="$topic" size="20x4" value="$percntFORMFIELD{$quotDescription$quot web=$quot$web$quot topic=$quot$topic$quot}$percnt" }% | $percntMULTITOPICSAVEINPUT{$quotType$quot type=$quotradio$quot size=$quot2$quot web=$quot$web$quot topic=$quot$topic$quot value=$quot$formfield(Type)$quot options=$quotBoolean, Integer, String, Discrete Strings$quot }$percnt | $percntMULTITOPICSAVEINPUT{$quotDefault$quot type=$quotcheckbox$quot size=$quot2$quot web=$quot$web$quot topic=$quot$topic$quot value=$quot$formfield(Default)$quot options=$quotape, cat, elephant, mouse$quot }$percnt | $percntMULTITOPICSAVEINPUT{$quotThird$quot type=$quotselect$quot size=$quot0$quot multiple=$quoton$quot web=$quot$web$quot topic=$quot$topic$quot value=$quot$formfield(Third)$quot options=$quotape, cat, elephant, mouse$quot }$percnt |"
}%

%MULTITOPICSAVESUBMIT{"Submit all changes"}%

</form>
</verbatim>


---++ Plugin Use

In the topic you must create a html form which targets the rest script of this plugin. This must be a post. The form would look like this

<verbatim>
<form action='%SCRIPTURL{"rest"}%/MultiTopicSavePlugin/multitopicsave' method="post">
</form>
</verbatim>

In the form you need to define fields that must have the name: =multitopicsavefield{Webname.Topicname}{Fieldname}= where the Webname.Topicname is the fully qualified name of the target topic and the Fieldname is the name of the form field you want to change.

Example
<verbatim>
<input type='text' size='20' name='multitopicsavefield{Myweb.MultiTopicSaveTestTarget2}{Name}' value='$formfield(Name}' />
</verbatim>

To ease this task you can use the MULTITOPICSAVEINPUT macro to generate the correct fields. At of this moment only text and textarea fields are supported by a macro. But other types can be used by using HTML.

In addition the form must submit two hidden fields redirectweb and redirecttopic that specify the topic to which you are redirected when you submit. 

<verbatim>
<input type='hidden' name='redirectweb' value='Myweb' />
<input type='hidden' name='redirecttopic' value='MultiTopicSaveTest' />
</verbatim>

To ease this task you can use the MULTITOPICSAVESUBMIT which creates a submit button and per default redirects the user back to the original topic from which the form was submitted.

   * %<nop>MULTITOPICSAVESUBMIT{"Submit button text}%
      * This Macro adds a submit button with the text defined. It additionally adds the hidden fields that the plugin needs to send to return to the current topic after submission.
      
   * %<nop>MULTITOPICSAVEINPUT{"Field name" type="field type" multiple="on|off" size="field size" web="webname" topic="topicname" value="desplayed value in field" options="list of options"}%
      * Field name - the name of the field in the data form. If the field name has spaces you need to ommit the spaces
      * type = type of input field. Valid types are text, textarea, radio, checkbox, select, and hidden
      * multiple = allow multiple values for fields of the select type. For other types of fields this parameter is ignored
      * size = the size of the input text field (single number) or textarea (width x height).
         * Example for textarea: '80x4' for 80 columns wide by 4 lines tall.
         * For checkbox and radio fields the size defines the number of buttons/checkboxes shown before in each displayed row of buttons/checkboxes. To show all the buttons in one row select a very large number. To show them all below each other set size to 1. Default is 1.
         * For select the size defines the number of values displayed in the input window. If no size is given all values are shown for multiple fields and a simple pulldown is shown for non-multiple.
         * For hidden fields size is ignored
      * web = web of the target topic. In formatted searches you can put $web here
      * topic = name of the target topic. In formatted searches you can put $topic here
      * value = the value that is put in the field by default
      * options = the values to choose between for types radio, select etc. This value is ignored for text, textarea, and hidden. Options are separated by commas, example: options="dog, cat, horse"
      
Note that the input fields generated by MULTITOPICSAVEINPUT have only single quotes (') allowing the use in the format parameter of SEARCH.
      
---++ Examples of input field types with MULTITOPICSAVEINPUT

---+++ text

=%<nop>MULTITOPICSAVEINPUT{"Field name" type="text" size="field size" web="webname" topic="topicname" value="desplayed value in field"}%=

This is the most simple type. This creates a plain text field which has a width given by the size parameter. In a formatted search you can use this type without delaying the expansion of the macro with $percnt and $quot.

Example of use in formatted search format

<verbatim>
%MULTITOPICSAVEINPUT{"Option" type="text" size="20" web="$web" topic="$topic" value="$formfield(Option)"}%
</verbatim>

---+++ textarea

=%<nop>MULTITOPICSAVEINPUT{"Field name" type="textarea" size="COLxROWS" web="webname" topic="topicname" value="desplayed value in field"}%=

The textarea produces a text entry field with width and number of displayed lines as defined by the size parameter. Size is given as "20x4" for 4 lines of 20 characters each. You can input more than the 4 lines. The browser will add a scroll bar to the field.

Note that for textareas we cannot use the SEARCH feature =$formfield= because it encodes newlines as &lt;br /&gt; (to avoid breaking tables) which is not desired when you want to show the current value in a text box. Instead we can use the standard macro %<nop>FORMFIELD% which does not perform any translation. Linebreaks will not break TML defined tables when they are inside a textarea field. We have to delay the expansion of FORMFIELD till after the SEARCH has completed which is why it has to written with the use of $percnt and $quot.

Example of use in formatted search format

<verbatim>
%MULTITOPICSAVEINPUT{"Description" type="textarea" web="$web" topic="$topic" size="20x4" value="$percntFORMFIELD{$quotDescription$quot web=$quot$web$quot topic=$quot$topic$quot}$percnt" }%
</verbatim>


---+++ radio/checkbox

=%<nop>MULTITOPICSAVEINPUT{"Field name" type="radio|checkbox" size="options per line" web="webname" topic="topicname" value="pre-selected values" options="list of options"}%=

Radio buttons allows you to select one value of many. It is not possible to unselect all in the browser once one is selected.

Checkboxes allow multiple values to be checked and you can unselect all values.

Values listed (comma separated if more than one for checkbox fields) will be checked when page is loaded in the browser.

In formatted searches where we use MULTITOPICSAVEINPUT inside the format parameter of the SEARCH we have to delay the expansion with $percnt and $quot. The reason is that MULTITOPICSAVEINPUT needs to know the current value of the field for each found topic to be able to show the right radio button as checked. Without the $percnt/$quots the MULTITOPICSAVEINPUT would be expanded before the SEARCH is run with the string $formfield(Fieldname) as an unexpanded fixed text string. The result will be that none of the buttons/checkboxes/select fields will be be selected when viewed.

The size defined how many options will be displayed in a row. If you have 6 options and set the size as 2 you will see 3 rows with 2 buttons/checkboxes in each.

The options parameter defines the values that will be presented. You define the options as a comma separated text string. Example: options="cat, mouse, dog and pony, elephant". Leading and trailing whitespace is removed from each value. Each value can be multiple words.

Both radio buttons and checkboxes are shown with the value to the right of the button/checkbox. 

Example of radio button field in formatted search format

<verbatim>
$percntMULTITOPICSAVEINPUT{$quotType$quot type=$quotradio$quot size=$quot2$quot web=$quot$web$quot topic=$quot$topic$quot value=$quot$formfield(Type)$quot options=$quotBoolean, Integer, String, Discrete Strings$quot }$percnt
</verbatim>


Example of checkbox field in formatted search format

<verbatim>
$percntMULTITOPICSAVEINPUT{$quotDefault$quot type=$quotcheckbox$quot size=$quot2$quot web=$quot$web$quot topic=$quot$topic$quot value=$quot$formfield(Default)$quot options=$quotape, cat, elephant, mouse$quot }$percnt
</verbatim>

---+++ select

=%<nop>MULTITOPICSAVEINPUT{"Field name" type="select" multiple="on|off" size="number of shown options" web="webname" topic="topicname" value="pre-selected values" options="list of options"}%=

The select field presents the values as a pull down list or scrollable list depending of the size. The select fields can be single value or multiple value. Multiple values are selected by using control + mouseclick.

The size parameter defines the number of values displayed in the input window. If no size is given all values are shown for multiple fields and a simple pulldown is shown for non-multiple. A size of 1 will give a pulldown window if it is not a multiple value field. If there are more options than given by the size the browser will add a scroll bar.

Values listed (comma separated if multiple values) will be pre-selected when page is loaded in the browser.

Like with buttons/checkboxes we have to delay the expansion of MULTITOPICSAVEINPUT with $percnt and $quot if the macro is used in the format parameter of SEARCH.

Example of select field in formatted search format

<verbatim>
$percntMULTITOPICSAVEINPUT{$quotThird$quot type=$quotselect$quot size=$quot0$quot multiple=$quoton$quot web=$quot$web$quot topic=$quot$topic$quot value=$quot$formfield(Third)$quot options=$quotape, cat, elephant, mouse$quot }$percnt
</verbatim>

---+++ hidden

Hidden fields allow submitting values without displaying them to the user. This type is typically used in combination with radio, checkbox or select when you want to add additional values to a multiple value field without showing the existing values to the user.

For example. You have many topics with a field with combinations of values A, B and C. You want to let the user add the value D to many of the topics by selecting a single checkbox and a single submit. We use a combination of a hidden field and a checkbox field with the same field name. The hidden field is given the existing values. The SEARCH is made so it only shows the topic that do not have the value D.

<verbatim>
%SEARCH{"NOT(Platforms ~ '*D*') AND name ~ 'FuncReq*'" type="query" nonoise="on" format="| [[$topic][$formfield(Title)]] |$percntMULTITOPICSAVEINPUT{$quotPlatforms$quot type=$quothidden$quot web=$quot$web$quot topic=$quot$topic$quot value=$quot$formfield(Platforms)$quot }$percnt $percntMULTITOPICSAVEINPUT{$quotPlatforms$quot type=$quotcheckbox$quot size=$quot0$quot multiple=$quoton$quot web=$quot$web$quot topic=$quot$topic$quot value=$quot$quot options=$quotD$quot }$percnt |"}%
</verbatim>


<!--
One line description, required for extensions repository catalog.
   * Set SHORTDESCRIPTION = %$SHORTDESCRIPTION%
-->

---++ Installation
%$INSTALL_INSTRUCTIONS%

---++ Plugin Info

|  Author: | Foswiki:Main.KennethLavrsen |
|  Copyright: | &copy; 2010, Kenneth Lavrsen |
|  License: | GPL ([[http://www.gnu.org/copyleft/gpl.html][GNU General Public License]]) |
|  Release: | %$RELEASE% |
|  Version: | %$VERSION% |
|  Change&nbsp;History: | <!-- versions below in reverse order -->&nbsp; |
|  17 Feb 2010 (1.1) | Added type hidden. Added examples of use of all the different field types |
|  16 Feb 2010 (1.0) | First version of plugin |
|  Home: | http://foswiki.org/Extensions/%TOPIC% |
|  Support: | http://foswiki.org/Support/%TOPIC% |

%META:FILEATTACHMENT{name="example.png" attachment="example.png" attr="h" comment="" date="1266362936" path="example.png" user="ProjectContributor" version="1"}%
